<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Controle de Saldos (Califórnia Transportes)</title>
  <link rel="icon" href="https://californiatransportes.github.io/saldos/controle/california.ico" type="image/x-icon">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    .actions-menu {
      min-width: 180px;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      top: 100%; /* abre para baixo */
      right: 0;
    }
    .actions-menu button, .actions-menu a {
      display: block;
      width: 100%;
      padding: 8px 12px;
      text-align: left;
      font-size: 0.875rem;
    }
    .modal-bg { background: rgba(0,0,0,0.5); }
    .acoes-col { width: 1%; white-space: nowrap; }
.truncate {
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}
.max-w-32 { max-width: 8rem; }
.max-w-28 { max-width: 7rem; }
.max-w-24 { max-width: 6rem; }
  </style>
</head>
<body class="bg-gray-100 text-gray-800">

  <div class="max-w-7xl mx-auto p-4">

    <!-- HEADER -->
    <header class="flex items-center gap-4 mb-6">
      <img src="https://i.ibb.co/ksSbDJKH/33fbdb6f-b2d9-44c4-963e-c559e83d6766.png" alt="logo" class="w-20 h-20 object-contain">
      <div>
        <h1 class="text-2xl font-bold">Controle de Saldos — Califórnia Transportes</h1>
        <p class="text-sm text-gray-600">Painel de Saldos - Desenvolvido by Je4nGomes</p>
        <p class="text-xs text-blue-600 mt-1">
          <a href="https://californiatransportes.github.io/saldos/cadastro.html" target="_blank" class="underline">Cadastrar Motoristas, Transportadoras e Envelopes</a>
        </p>
      </div>
    </header>

    <!-- CARDS -->
    <section class="grid grid-cols-1 lg:grid-cols-4 gap-4 mb-6">
      <div class="bg-white p-4 rounded-lg shadow">
        <p class="text-sm text-gray-500">Saldo Total</p>
        <p id="card-saldo" class="text-2xl font-bold text-red-600">R$ 0,00</p>
      </div>
      <div class="bg-white p-4 rounded-lg shadow">
        <p class="text-sm text-gray-500">Saldos em Aberto</p>
        <p id="card-aberto" class="text-2xl font-bold text-orange-500">0</p>
      </div>
      <div class="bg-white p-4 rounded-lg shadow">
        <p class="text-sm text-gray-500">Saldos Pagos</p>
        <p id="card-pagos" class="text-2xl font-bold text-green-600">0</p>
      </div>
      <div class="bg-white p-4 rounded-lg shadow">
        <p class="text-sm text-gray-500">Registros</p>
        <p id="card-total" class="text-2xl font-bold text-blue-600">0</p>
      </div>
    </section>

    <!-- GRÁFICOS (MENOR E POR MÊS) -->
    <section class="grid grid-cols-1 lg:grid-cols-3 gap-4 mb-6">
      <div class="bg-white p-3 rounded-lg shadow lg:col-span-2">
        <canvas id="chart-saldo" height="160"></canvas>
      </div>
      <div class="bg-white p-3 rounded-lg shadow">
        <canvas id="chart-status" height="160"></canvas>
      </div>
    </section>

    <!-- FORMULÁRIO -->
    <section class="bg-white p-4 rounded-lg shadow mb-6">
      <form id="formulario" class="grid grid-cols-2 md:grid-cols-4 gap-3">
        <select name="motorista" required class="border p-2 rounded text-sm">
          <option value="">Selecione Motorista</option>
        </select>
        <select name="transportadora" required class="border p-2 rounded text-sm">
          <option value="">Selecione Transportadora</option>
        </select>
        <input type="date" name="diaViagem" required class="border p-2 rounded text-sm" />
        <input name="cte" placeholder="CTe" class="border p-2 rounded text-sm" />
        <input name="nfe" placeholder="NFe" class="border p-2 rounded text-sm" />
        <select name="status" required class="border p-2 rounded text-sm">
          <option value="">Selecione Status</option>
          <option value="Na empresa, não enviado" style="background:#fca5a5; color:#991b1b;">Na empresa, não enviado</option>
          <option value="Com motorista" style="background:#fdba74; color:#9a3412;">Com motorista</option>
          <option value="Enviado para recebimento" style="background:#93c5fd; color:#1e40af;">Enviado para recebimento</option>
          <option value="Pago" style="background:#86efac; color:#166534;">Pago</option>
        </select>
        <input name="codigoRastreio" placeholder="Código de Rastreio" class="border p-2 rounded text-sm" />
        <select name="envelope" required class="border p-2 rounded text-sm">
          <option value="">Selecione Envelope</option>
        </select>
        <input type="number" name="valorFrete" placeholder="Valor Frete" step="0.01" required class="border p-2 py-1 rounded text-sm" />
        <input type="number" name="adiantamento" placeholder="Adiantamento" step="0.01" required class="border p-2 py-1 rounded text-sm" />
        <button type="submit" class="bg-blue-600 text-white p-2 rounded col-span-2 md:col-span-1 text-sm hover:bg-blue-700">Salvar (senha)</button>
      </form>

      <!-- FILTROS -->
      <div class="flex flex-wrap gap-3 mt-4">
        <input id="filtroMotorista" placeholder="Filtrar Motorista" class="border p-2 rounded text-sm" />
        <input id="filtroTransportadora" placeholder="Filtrar Transportadora" class="border p-2 rounded text-sm" />
        <input id="filtroCte" placeholder="Filtrar CTe" class="border p-2 rounded text-sm" />
        <input id="filtroEnvelope" placeholder="Filtrar Envelope" class="border p-2 rounded text-sm" />
        <input id="filtroData" type="date" class="border p-2 rounded text-sm" />
        <button id="btnFiltrar" class="bg-indigo-600 text-white px-4 py-2 rounded text-sm hover:bg-indigo-700">Aplicar Filtros</button>
        <button id="btnExportar" class="bg-green-600 text-white px-4 py-2 rounded text-sm hover:bg-green-700">Exportar .xlsx</button>
      </div>
    </section>

<!-- TABELA (COMPACTA E INTELIGENTE) -->
<section class="bg-white p-4 rounded-lg shadow mb-6 overflow-x-auto">
  <h2 class="text-lg font-bold mb-3">Registros</h2>
  <div class="overflow-x-auto">
    <table class="min-w-full text-xs table-auto"> <!-- text-xs -->
      <thead>
        <tr class="bg-gray-100">
          <th class="border px-1 py-1 whitespace-nowrap"><input type="checkbox" id="selectAll"></th>
          <th class="border px-1 py-1 whitespace-nowrap max-w-32">Motorista</th> <!-- 32 chars max -->
          <th class="border px-1 py-1 whitespace-nowrap max-w-28">Transp.</th>  <!-- 28 chars max -->
          <th class="border px-1 py-1 whitespace-nowrap">Viagem</th>
          <th class="border px-1 py-1 whitespace-nowrap">CTe</th>
          <th class="border px-1 py-1 whitespace-nowrap">NFe</th>
          <th class="border px-1 py-1 whitespace-nowrap max-w-24">Status</th>  <!-- 24 chars max -->
          <th class="border px-1 py-1 whitespace-nowrap">Rastreio</th>
          <th class="border px-1 py-1 whitespace-nowrap">Envelope</th>
          <th class="border px-1 py-1 whitespace-nowrap text-right">Frete</th>
          <th class="border px-1 py-1 whitespace-nowrap text-right">Adiant.</th>
          <th class="border px-1 py-1 whitespace-nowrap text-right font-bold">Saldo</th>
          <th class="border px-1 py-1 whitespace-nowrap">Data Receb.</th>
          <th class="border px-1 py-1 acoes-col"></th>
        </tr>
      </thead>
      <tbody id="lista"></tbody>
    </table>
  </div>
</section>

    <footer class="text-center text-gray-500 text-xs">Desenvolvido by Je4nGomes</footer>
  </div>

  <!-- SCRIPTS -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
    import { getDatabase, ref, push, onValue, update, remove } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";
    import { getStorage, ref as storageRef, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-storage.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDmryG-PKAyU1at8VL7NPRAZAetsoO3sdY",
      authDomain: "saldo-d8113.firebaseapp.com",
      databaseURL: "https://saldo-d8113-default-rtdb.firebaseio.com",
      projectId: "saldo-d8113",
      storageBucket: "saldo-d8113.appspot.com",
      messagingSenderId: "21759024447",
      appId: "1:21759024447:web:55ecbcceb69d9c48f5478a",
      measurementId: "G-78J9NTWH8L"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const storage = getStorage(app);
    const saldosRef = ref(db, 'saldos');
    const cadastrosRef = ref(db, 'cadastros');

    const form = document.getElementById('formulario');
    const lista = document.getElementById('lista');
    const filtroMotorista = document.getElementById('filtroMotorista');
    const filtroTransportadora = document.getElementById('filtroTransportadora');
    const filtroData = document.getElementById('filtroData');
    const filtroCte = document.getElementById('filtroCte');
    const filtroEnvelope = document.getElementById('filtroEnvelope');
    const btnExportar = document.getElementById('btnExportar');
    const btnFiltrar = document.getElementById('btnFiltrar');

    const CARD_SALDO = document.getElementById('card-saldo');
    const CARD_ABERTO = document.getElementById('card-aberto');
    const CARD_PAGOS = document.getElementById('card-pagos');
    const CARD_TOTAL = document.getElementById('card-total');

    let chartStatus = null;
    let chartSaldo = null;
    let senhaAutenticada = false;
    const senhaMestra = '35280712';

    const formatarNumero = (n) => Number(n || 0).toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    const formatarData = (iso) => {
      if (!iso) return '-';
      const d = new Date(iso);
      if (isNaN(d)) return iso;
      return `${String(d.getDate()).padStart(2,'0')}/${String(d.getMonth()+1).padStart(2,'0')}/${d.getFullYear()} ${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`;
    };

    let todosOsRegistros = [];
    let dadosExportacao = [];
    let motoristas = [];
    let transportadoras = [];
    let envelopes = [];

    onValue(cadastrosRef, (snap) => {
      const data = snap.val() || {};
      motoristas = Object.values(data).filter(c => c.tipo === 'motorista').map(c => c.nome).sort();
      transportadoras = Object.values(data).filter(c => c.tipo === 'transportadora').map(c => c.nome).sort();
      envelopes = Object.values(data).filter(c => c.tipo === 'envelope').map(c => c.nome).sort();
      popularSelects();
    });

    function popularSelects() {
      const selectMotorista = form.querySelector('select[name="motorista"]');
      selectMotorista.innerHTML = '<option value="">Selecione Motorista</option>' + motoristas.map(m => `<option value="${m}">${m}</option>`).join('');

      const selectTransportadora = form.querySelector('select[name="transportadora"]');
      selectTransportadora.innerHTML = '<option value="">Selecione Transportadora</option>' + transportadoras.map(t => `<option value="${t}">${t}</option>`).join('');

      const selectEnvelope = form.querySelector('select[name="envelope"]');
      selectEnvelope.innerHTML = '<option value="">Selecione Envelope</option>' + envelopes.map(e => `<option value="${e}">${e}</option>`).join('');
    }

    onValue(saldosRef, (snap) => {
      const data = snap.val() || {};
      todosOsRegistros = Object.entries(data).map(([key, val]) => ({ key, ...val }));
      aplicarFiltros();
      montarCardsCharts();
    });

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      const senha = prompt('Digite a senha para salvar:');
      if (senha !== senhaMestra) return alert('Senha incorreta!');

      const dados = Object.fromEntries(new FormData(form).entries());
      dados.valorFrete = parseFloat(dados.valorFrete || 0);
      dados.adiantamento = parseFloat(dados.adiantamento || 0);
      dados.saldo = parseFloat((dados.valorFrete - dados.adiantamento).toFixed(2));
      dados.dataInsercao = new Date().toISOString();

      if (dados.status === 'Enviado para recebimento') {
        dados.dataEnvio = new Date().toISOString();
      }

      await push(saldosRef, dados);
      form.reset();
      alert('Registro salvo com sucesso!');
    });

    btnFiltrar.addEventListener('click', aplicarFiltros);

    function aplicarFiltros() {
      lista.innerHTML = '';
      dadosExportacao = [];

      const fM = filtroMotorista.value.toLowerCase().trim();
      const fT = filtroTransportadora.value.toLowerCase().trim();
      const fD = filtroData.value;
      const fC = filtroCte.value.toLowerCase().trim();
      const fE = filtroEnvelope.value.toLowerCase().trim();

      let filtrados = todosOsRegistros.filter(v => {
        return (!fM || (v.motorista || '').toLowerCase().includes(fM)) &&
               (!fT || (v.transportadora || '').toLowerCase().includes(fT)) &&
               (!fD || v.diaViagem === fD) &&
               (!fC || (v.cte || '').toLowerCase().includes(fC)) &&
               (!fE || (v.envelope || '').toLowerCase().includes(fE));
      });

      filtrados.sort((a, b) => (a.saldo > 0 ? 0 : 1) - (b.saldo > 0 ? 0 : 1));
      filtrados.forEach(r => renderizarLinha(r));
    }

function renderizarLinha(val) {
  const tr = document.createElement('tr');
  const bgColor = {
    'Na empresa, não enviado': 'bg-red-50',
    'Com motorista': 'bg-orange-50',
    'Enviado para recebimento': 'bg-blue-50',
    'Pago': 'bg-green-50'
  }[val.status] || '';
  const statusColor = {
    'Na empresa, não enviado': 'text-red-600',
    'Com motorista': 'text-orange-600',
    'Enviado para recebimento': 'text-blue-600',
    'Pago': 'text-green-600'
  }[val.status] || 'text-gray-700';

  // Função para truncar texto
  const truncar = (texto, max) => {
    if (!texto) return '-';
    return texto.length > max ? texto.substring(0, max - 3) + '...' : texto;
  };

  const motorista = truncar(val.motorista, 15);
  const transportadora = truncar(val.transportadora, 12);
  const statusAbrev = val.status === 'Na empresa, não enviado' ? 'Na empresa' :
                     val.status === 'Com motorista' ? 'Com mot.' :
                     val.status === 'Enviado para recebimento' ? 'Enviado' :
                     val.status === 'Pago' ? 'Pago' : val.status;

  tr.className = bgColor;
  tr.innerHTML = `
    <td class="border px-1 py-1 text-center"><input type="checkbox" class="rowCheck" data-saldo="${val.saldo || 0}" data-key="${val.key}"></td>
    <td class="border px-1 py-1 whitespace-nowrap max-w-32 truncate" title="${val.motorista || ''}">${motorista}</td>
    <td class="border px-1 py-1 whitespace-nowrap max-w-28 truncate" title="${val.transportadora || ''}">${transportadora}</td>
    <td class="border px-1 py-1 whitespace-nowrap">${val.diaViagem ? new Date(val.diaViagem).toLocaleDateString('pt-BR') : '-'}</td>
    <td class="border px-1 py-1 whitespace-nowrap">${val.cte || '-'}</td>
    <td class="border px-1 py-1 whitespace-nowrap">${val.nfe || '-'}</td>
    <td class="border px-1 py-1 whitespace-nowrap max-w-24 ${statusColor} font-medium" title="${val.status || ''}">${statusAbrev}</td>
    <td class="border px-1 py-1 whitespace-nowrap">${val.codigoRastreio || '-'}</td>
    <td class="border px-1 py-1 whitespace-nowrap">${val.envelope || '-'}</td>
    <td class="border px-1 py-1 whitespace-nowrap text-right">R$ ${formatarNumero(val.valorFrete)}</td>
    <td class="border px-1 py-1 whitespace-nowrap text-right">R$ ${formatarNumero(val.adiantamento)}</td>
    <td class="border px-1 py-1 whitespace-nowrap text-right font-bold">R$ ${formatarNumero(val.saldo)}</td>
    <td class="border px-1 py-1 whitespace-nowrap">${val.dataRecebimento ? formatarData(val.dataRecebimento) : '-'}</td>
    <td class="border px-1 py-1 acoes-col align-middle">
      <div class="relative">
        <button data-key="${val.key}" class="actions-btn bg-gray-600 hover:bg-gray-700 text-white px-2 py-0.5 rounded text-xs">Ações</button>
        <div id="actions-menu-${val.key}" class="actions-menu hidden absolute bg-white border rounded shadow-lg z-50 top-full right-0 mt-1">
          ${val.pdfUrl 
            ? `<a href="${val.pdfUrl}" target="_blank" class="text-blue-600 hover:bg-gray-100 block px-3 py-1 text-xs">Ver PDF</a>`
            : `<button data-key="${val.key}" class="upload-btn text-blue-600 hover:bg-gray-100 w-full text-left px-3 py-1 text-xs">Anexar PDF</button>`
          }
          <button data-key="${val.key}" class="delete-btn text-red-600 hover:bg-gray-100 w-full text-left px-3 py-1 text-xs">Excluir</button>
          ${val.saldo > 0 ? `<button data-key="${val.key}" class="mark-recebido-btn text-green-600 hover:bg-gray-100 w-full text-left px-3 py-1 text-xs">Marcar como Recebido</button>` : ''}
          <button data-key="${val.key}" class="edit-btn text-yellow-700 hover:bg-gray-100 w-full text-left px-3 py-1 text-xs">Editar</button>
        </div>
      </div>
    </td>
  `;
  lista.appendChild(tr);

  dadosExportacao.push({
    Motorista: val.motorista || '',
    Transportadora: val.transportadora || '',
    DiaViagem: val.diaViagem || '',
    CTe: val.cte || '',
    NFe: val.nfe || '',
    Status: val.status || '',
    CodigoRastreio: val.codigoRastreio || '',
    Envelope: val.envelope || '',
    Frete: formatarNumero(val.valorFrete),
    Adiantamento: formatarNumero(val.adiantamento),
    Saldo: formatarNumero(val.saldo),
    DataRecebimento: val.dataRecebimento || '',
    DataInsercao: val.dataInsercao || '',
    PDF: val.pdfUrl || ''
  });
}

    btnExportar.addEventListener('click', () => {
      const ws = XLSX.utils.json_to_sheet(dadosExportacao);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, 'Saldos');
      XLSX.writeFile(wb, `saldos_${new Date().toISOString().slice(0,10)}.xlsx`);
    });

    document.addEventListener('click', async (e) => {
      const key = e.target.getAttribute('data-key');
      if (!key) return;

      if (e.target.classList.contains('actions-btn')) {
        if (!senhaAutenticada) {
          const senha = prompt('Digite a senha para ações:');
          if (senha !== senhaMestra) return alert('Senha incorreta!');
          senhaAutenticada = true;
        }
        const menu = document.getElementById(`actions-menu-${key}`);
        menu.classList.toggle('hidden');
      }

      if (e.target.classList.contains('upload-btn')) {
        const input = document.createElement('input');
        input.type = 'file'; input.accept = 'application/pdf'; input.style.display = 'none';
        document.body.appendChild(input); input.click();
        input.addEventListener('change', async () => {
          const file = input.files[0];
          if (file) {
            const fileRef = storageRef(storage, `pdfs/${key}.pdf`);
            await uploadBytes(fileRef, file);
            const url = await getDownloadURL(fileRef);
            await update(ref(db, `saldos/${key}`), { pdfUrl: url });
            alert('PDF anexado com sucesso!');
          }
          document.body.removeChild(input);
        });
      }

      if (e.target.classList.contains('delete-btn') && confirm('Excluir este registro?')) {
        await remove(ref(db, `saldos/${key}`));
      }

      if (e.target.classList.contains('mark-recebido-btn')) {
        let data = prompt('Data de recebimento (ou deixe em branco para agora):');
        if (data === null) return;
        if (!data.trim()) data = new Date().toLocaleString('pt-BR');
        await update(ref(db, `saldos/${key}`), { saldo: 0, dataRecebimento: data, status: 'Pago' });
      }

      if (e.target.classList.contains('edit-btn')) {
        const reg = todosOsRegistros.find(r => r.key === key);
        if (!reg) return;

        const modal = document.createElement('div');
        modal.className = 'fixed inset-0 modal-bg flex items-center justify-center z-50';
        modal.innerHTML = `
          <div class="bg-white p-6 rounded-lg shadow-lg w-full max-w-2xl">
            <h3 class="text-xl font-bold mb-4">Editar Registro</h3>
            <form id="form-edit-${key}" class="grid grid-cols-2 gap-3 text-sm">
              <select name="motorista" class="border p-2 rounded" required>
                <option value="">Selecione Motorista</option>
                ${motoristas.map(m => `<option value="${m}" ${reg.motorista===m?'selected':''}>${m}</option>`).join('')}
              </select>
              <select name="transportadora" class="border p-2 rounded" required>
                <option value="">Selecione Transportadora</option>
                ${transportadoras.map(t => `<option value="${t}" ${reg.transportadora===t?'selected':''}>${t}</option>`).join('')}
              </select>
              <input type="date" name="diaViagem" value="${reg.diaViagem||''}" class="border p-2 rounded" required />
              <input name="cte" value="${reg.cte||''}" class="border p-2 rounded" />
              <input name="nfe" value="${reg.nfe||''}" class="border p-2 rounded" />
              <select name="status" class="border p-2 rounded" required>
                <option value="Na empresa, não enviado" ${reg.status==='Na empresa, não enviado'?'selected':''} style="background:#fca5a5;color:#991b1b;">Na empresa, não enviado</option>
                <option value="Com motorista" ${reg.status==='Com motorista'?'selected':''} style="background:#fdba74;color:#9a3412;">Com motorista</option>
                <option value="Enviado para recebimento" ${reg.status==='Enviado para recebimento'?'selected':''} style="background:#93c5fd;color:#1e40af;">Enviado para recebimento</option>
                <option value="Pago" ${reg.status==='Pago'?'selected':''} style="background:#86efac;color:#166534;">Pago</option>
              </select>
              <input name="codigoRastreio" value="${reg.codigoRastreio||''}" class="border p-2 rounded" />
              <select name="envelope" class="border p-2 rounded">
                <option value="">Selecione Envelope</option>
                ${envelopes.map(e => `<option value="${e}" ${reg.envelope===e?'selected':''}>${e}</option>`).join('')}
              </select>
              <input type="number" name="valorFrete" value="${reg.valorFrete||0}" step="0.01" class="border p-2 rounded" required />
              <input type="number" name="adiantamento" value="${reg.adiantamento||0}" step="0.01" class="border p-2 rounded" required />
              <div class="col-span-2 flex gap-2">
                <button type="submit" class="bg-blue-600 text-white p-2 rounded flex-1">Salvar</button>
                <button type="button" id="cancel-${key}" class="bg-gray-400 text-white p-2 rounded flex-1">Cancelar</button>
              </div>
            </form>
          </div>
        `;
        document.body.appendChild(modal);

        document.getElementById(`cancel-${key}`).onclick = () => modal.remove();

        document.getElementById(`form-edit-${key}`).addEventListener('submit', async (ev) => {
          ev.preventDefault();
          const dados = Object.fromEntries(new FormData(ev.target).entries());
          dados.valorFrete = parseFloat(dados.valorFrete || 0);
          dados.adiantamento = parseFloat(dados.adiantamento || 0);
          dados.saldo = parseFloat((dados.valorFrete - dados.adiantamento).toFixed(2));
          if (dados.status === 'Enviado para recebimento') dados.dataEnvio = new Date().toISOString();
          await update(ref(db, `saldos/${key}`), dados);
          modal.remove();
        });
      }
    });

    // === GRÁFICOS POR MÊS ===
    function montarCardsCharts() {
      CARD_TOTAL.textContent = todosOsRegistros.length;

      const totais = todosOsRegistros.reduce((acc, r) => {
        acc.saldoTotal += Number(r.saldo || 0);
        if (Number(r.saldo || 0) > 0) acc.aberto++;
        else acc.pago++;
        return acc;
      }, { saldoTotal: 0, aberto: 0, pago: 0 });

      CARD_SALDO.textContent = `R$ ${formatarNumero(totais.saldoTotal)}`;
      CARD_ABERTO.textContent = totais.aberto;
      CARD_PAGOS.textContent = totais.pago;

      // GRÁFICO DE STATUS
      const statusCount = {};
      todosOsRegistros.forEach(r => {
        const s = r.status || 'Outro';
        statusCount[s] = (statusCount[s] || 0) + 1;
      });

      const ctxStatus = document.getElementById('chart-status').getContext('2d');
      if (chartStatus) chartStatus.destroy();
      chartStatus = new Chart(ctxStatus, {
        type: 'pie',
        data: {
          labels: Object.keys(statusCount),
          datasets: [{
            data: Object.values(statusCount),
            backgroundColor: ['#ef4444', '#f97316', '#3b82f6', '#22c55e']
          }]
        },
        options: { responsive: true, plugins: { legend: { position: 'bottom' } } }
      });

      // GRÁFICO DE SALDO POR MÊS (ACUMULADO)
      const ctxSaldo = document.getElementById('chart-saldo').getContext('2d');
      if (chartSaldo) chartSaldo.destroy();

      const porMes = {};
      todosOsRegistros.forEach(r => {
        if (!r.diaViagem) return;
        const mesAno = r.diaViagem.substring(0, 7); // YYYY-MM
        porMes[mesAno] = (porMes[mesAno] || 0) + Number(r.saldo || 0);
      });

      const mesesOrdenados = Object.keys(porMes).sort();
      const labels = mesesOrdenados.map(m => {
        const [ano, mes] = m.split('-');
        const data = new Date(ano, mes - 1);
        return data.toLocaleDateString('pt-BR', { month: 'short', year: 'numeric' });
      });
      const valores = mesesOrdenados.map(m => porMes[m]);

      chartSaldo = new Chart(ctxSaldo, {
        type: 'bar',
        data: {
          labels: labels,
          datasets: [{
            label: 'Saldo em Aberto',
            data: valores,
            backgroundColor: '#dc2626',
            borderColor: '#b91c1c',
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          plugins: { legend: { display: false } },
          scales: {
            y: { beginAtZero: true }
          }
        }
      });
    }

    // CHECKBOXES
    lista.addEventListener('change', (e) => {
      if (e.target.classList.contains('rowCheck')) {
        let total = 0;
        document.querySelectorAll('.rowCheck:checked').forEach(c => total += parseFloat(c.dataset.saldo || 0));
        CARD_SALDO.textContent = `R$ ${formatarNumero(total)}`;
      }
    });

    document.getElementById('selectAll').addEventListener('change', (e) => {
      document.querySelectorAll('.rowCheck').forEach(c => c.checked = e.target.checked);
      const total = e.target.checked ? todosOsRegistros.reduce((a,r) => a + Number(r.saldo||0), 0) : 0;
      CARD_SALDO.textContent = `R$ ${formatarNumero(total)}`;
    });

    montarCardsCharts();
  </script>
</body>
</html>
